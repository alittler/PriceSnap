<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceSnap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tesseract.js CDN -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
        }
        /* Hide the default file input */
        input[type="file"] {
            display: none;
        }
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover; /* This will crop and center the image */
            border-radius: 0.75rem; /* rounded-lg */
        }
        /* Custom styles for API Selector */
        .api-option-btn {
            transition: all 0.2s ease-in-out;
        }
        .api-option-btn.selected {
            background-color: #06b6d4; /* cyan-500 */
            color: #fff;
        }
        .best-deal-glow {
            box-shadow: 0 0 15px 4px rgba(250, 204, 21, 0.4); /* amber-300 glow */
            border-color: #FBBF24 !important; /* amber-400 */
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col items-center justify-start p-4 sm:p-6 md:p-8">

    <div class="w-full max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 flex flex-col items-center justify-center">
            <div class="flex items-center gap-4">
                 <svg class="w-12 h-12 sm:w-14 sm:h-14 text-amber-300" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21.24 13.62L16.2 20.26c-1.42 1.86-3.88 2.45-6.02 1.43l-5.18-2.48c-2.14-1.02-3.1-3.56-2.08-5.7l5.04-10.48c1.02-2.14 3.56-3.1 5.7-2.08l5.18 2.48c2.14 1.02 3.1 3.56 2.08 5.7z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.5"/>
                    <circle cx="17.5" cy="6.5" r="1" fill="currentColor"/>
                </svg>
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold bg-gradient-to-r from-amber-300 to-orange-400 text-transparent bg-clip-text">PriceSnap</h1>
            </div>
            <p class="text-slate-400 mt-2 text-sm sm:text-base">Add up to 5 photos. Let AI find the best deal.</p>
        </header>

        <!-- API Selector -->
        <div id="apiSelector" class="flex items-center justify-center p-1 bg-slate-800 rounded-full mb-8 max-w-md mx-auto">
            <button data-api="gemini" class="api-option-btn selected w-1/2 py-2 px-4 rounded-full font-semibold text-sm">Gemini AI</button>
            <button data-api="tesseract" class="api-option-btn w-1/2 py-2 px-4 rounded-full font-semibold text-sm text-slate-400">Tesseract.js + AI</button>
        </div>

        <!-- Main Comparison Area -->
        <main id="imageSlotsContainer" class="flex flex-wrap justify-center gap-6">
            <!-- Image slots will be dynamically inserted here -->
        </main>

        <!-- Action Buttons -->
        <div id="actionButtons" class="text-center mt-8">
            <button id="resetBtn" class="hidden w-full sm:w-auto bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 px-10 rounded-full transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-slate-600/50">
                Start Over
            </button>
        </div>

        <!-- AI Results Section -->
        <div id="resultsContainer" class="w-full mx-auto mt-10 p-4 sm:p-6 rounded-xl hidden">
            <!-- Loading Spinner -->
            <div id="loader" class="text-center hidden">
                <svg class="animate-spin h-10 w-10 text-cyan-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loaderText" class="mt-4 text-slate-400">AI is analyzing the images...</p>
            </div>
            <!-- Results Content -->
            <div id="resultsContent" class="hidden">
                <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-center mb-8">
                    <!-- Result cards will be dynamically inserted here -->
                </div>

                <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-amber-300 to-orange-400 text-transparent bg-clip-text mb-6 text-center">Comparison Result</h2>
                <div id="summary" class="text-base sm:text-lg text-center bg-slate-800/50 border border-slate-700 p-4 rounded-xl mb-6 text-slate-300"></div>
                
                <!-- Price List Section -->
                <div id="priceListContainer" class="w-full max-w-4xl mx-auto mb-8">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-slate-300 text-center mb-4">Price Summary</h3>
                        <ul id="priceList" class="text-slate-400 space-y-3">
                            <!-- Prices will be dynamically inserted here -->
                        </ul>
                    </div>
                </div>

                <div class="mt-8 max-w-4xl mx-auto">
                    <h3 class="text-lg font-semibold text-slate-300 text-center">Math Steps</h3>
                    <p id="mathSteps" class="text-slate-400 bg-slate-800/50 border border-slate-700 p-4 rounded-xl mt-2 whitespace-pre-line"></p>
                </div>
            </div>
            <!-- Error Message -->
            <div id="errorContent" class="hidden text-center">
                <h2 class="text-xl font-bold text-red-500 mb-2">Analysis Failed</h2>
                <p class="text-slate-400">The AI could not process the images. Please try again with clearer photos.</p>
            </div>
        </div>

    </div>

    <script>
        const MAX_IMAGES = 5;
        let uploadedImages = [];
        let selectedAPI = 'gemini';

        const imageSlotsContainer = document.getElementById('imageSlotsContainer');
        const resetBtn = document.getElementById('resetBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const resultsContent = document.getElementById('resultsContent');
        const errorContent = document.getElementById('errorContent');
        const apiSelector = document.getElementById('apiSelector');
        
        apiSelector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                selectedAPI = e.target.dataset.api;
                document.querySelectorAll('.api-option-btn').forEach(btn => {
                    btn.classList.remove('selected', 'text-white');
                    btn.classList.add('text-slate-400');
                });
                e.target.classList.add('selected', 'text-white');
                e.target.classList.remove('text-slate-400');
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            const index = parseInt(event.target.dataset.index, 10);
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                uploadedImages[index] = {
                    src: base64String,
                    base64: base64String.split(',')[1]
                };
                renderUI(); 
                
                if (index === uploadedImages.length - 1 && uploadedImages.length < MAX_IMAGES) {
                    setTimeout(() => {
                        const allSlots = imageSlotsContainer.children;
                        const lastSlot = allSlots[allSlots.length - 1];
                        if (lastSlot) {
                            lastSlot.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            };
            reader.readAsDataURL(file);
        }

        function createFilledSlot(src, index) {
            const fileId = `file-replace-${index}`;
            const slot = document.createElement('div');
            slot.className = "group w-full max-w-sm h-64 md:h-80 bg-slate-900 rounded-2xl flex items-center justify-center border-2 border-solid border-slate-700 relative overflow-hidden";
            
            slot.innerHTML = `
                <label for="${fileId}" class="absolute inset-0 cursor-pointer">
                    <img src="${src}" class="absolute top-0 left-0 image-preview transition-transform duration-300 group-hover:scale-105" alt="Grocery item ${index + 1}">
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center p-4">
                        <svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691L7.985 5.944m0 0L4.804 9.126m3.182-3.182a8.25 8.25 0 0111.667 0l3.181 3.183" />
                        </svg>
                        <p class="mt-2 text-white font-semibold text-center">Tap to replace</p>
                    </div>
                    <input type="file" id="${fileId}" accept="image/*" capture="environment" data-index="${index}" class="hidden">
                </label>
                <button data-remove-index="${index}" class="absolute top-3 right-3 z-10 p-2 bg-slate-900/50 hover:bg-red-600/80 rounded-full transition-colors">
                    <svg class="w-5 h-5 text-white pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;

            const input = slot.querySelector('input');
            input.addEventListener('change', handleFileSelect);
            return slot;
        }

        function createNewImageSlot(index) {
            const fileId = `file-${index}`;
            const label = document.createElement('label');
            label.htmlFor = fileId;
            label.className = "cursor-pointer group w-full max-w-sm h-64 md:h-80 bg-slate-900/50 rounded-2xl flex items-center justify-center border-2 border-dashed border-slate-800 transition-all duration-300 hover:border-cyan-500 hover:bg-slate-900";
            label.innerHTML = `
                <div class="text-center p-6 w-full h-full flex flex-col items-center justify-center relative">
                    <div class="transition-transform duration-300 group-hover:scale-105">
                        <svg class="w-16 h-16 mx-auto text-slate-600 group-hover:text-cyan-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="mt-2 font-semibold text-slate-400 group-hover:text-cyan-400">Add Photo ${index + 1}</p>
                        <p class="text-xs text-slate-500">Tap to use camera</p>
                    </div>
                </div>
                <input type="file" id="${fileId}" accept="image/*" capture="environment" data-index="${index}" class="hidden">
            `;
            const input = label.querySelector('input');
            input.addEventListener('change', handleFileSelect);
            return label;
        }

        function createSpecialCompareSlot(index) {
            const fileId = `file-${index}`;
            const container = document.createElement('div');
            container.className = "w-full max-w-sm h-64 md:h-80 bg-slate-900/50 rounded-2xl flex flex-col border-2 border-dashed border-slate-800 overflow-hidden";
            
            container.innerHTML = `
                <label for="${fileId}" class="group cursor-pointer h-1/2 flex items-center justify-center transition-all duration-300 hover:bg-slate-900 relative p-4">
                    <div class="transition-transform duration-300 group-hover:scale-105 text-center">
                        <svg class="w-12 h-12 mx-auto text-slate-600 group-hover:text-cyan-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="mt-2 font-semibold text-slate-400 group-hover:text-cyan-400">Add Photo ${index + 1}</p>
                    </div>
                    <input type="file" id="${fileId}" accept="image/*" capture="environment" data-index="${index}" class="hidden">
                </label>
                <div class="border-t-2 border-dashed border-slate-800"></div>
                <button class="w-full h-1/2 bg-slate-900/50 hover:bg-slate-800 transition-colors text-cyan-400 font-semibold flex items-center justify-center p-4 text-lg">
                    Calculate Best Deal
                </button>
            `;
            
            const input = container.querySelector(`#${fileId}`);
            input.addEventListener('change', handleFileSelect);

            const compareBtn = container.querySelector('button');
            compareBtn.addEventListener('click', startAnalysis);
            
            return container;
        }

        function renderUI() {
            imageSlotsContainer.innerHTML = ''; 
            const validImages = uploadedImages.filter(Boolean);
            validImages.forEach((imgData, index) => {
                imageSlotsContainer.appendChild(createFilledSlot(imgData.src, index));
            });
            if (validImages.length < MAX_IMAGES) {
                const nextSlot = (validImages.length < 2) ? createNewImageSlot(validImages.length) : createSpecialCompareSlot(validImages.length);
                imageSlotsContainer.appendChild(nextSlot);
            }
        }

        function prepareForAnalysis() {
            resultsContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultsContent.classList.add('hidden');
            errorContent.classList.add('hidden');
            const priceListContainer = document.getElementById('priceListContainer');
            priceListContainer.classList.add('hidden');
            document.getElementById('priceList').innerHTML = '';
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        async function startAnalysis() {
            prepareForAnalysis();
            switch (selectedAPI) {
                case 'tesseract':
                    await callTesseractAPI();
                    break;
                default:
                    await callGeminiAPI();
            }
        }
        
        async function callTesseractAPI() {
            const validImages = uploadedImages.filter(Boolean);
            const extractedTexts = [];
            let fallbackNeeded = false;

            try {
                const worker = await Tesseract.createWorker('eng');
                for (let i = 0; i < validImages.length; i++) {
                    loaderText.textContent = `Performing on-device OCR... (${i + 1}/${validImages.length})`;
                    const ret = await worker.recognize(validImages[i].src);
                    const extractedText = ret.data.text.trim();

                    if (extractedText) {
                        extractedTexts.push(`--- Image ${i + 1} Text ---\n${extractedText}\n\n`);
                    } else {
                        console.log(`Tesseract failed on image ${i + 1}. Triggering fallback.`);
                        fallbackNeeded = true;
                        break; // Exit the loop immediately
                    }
                }
                await worker.terminate();

                if (fallbackNeeded) {
                    loaderText.textContent = "On-device OCR failed on an image. Falling back to Gemini AI for all images...";
                    await callGeminiAPI();
                } else {
                    loaderText.textContent = "Analyzing extracted text with AI...";
                    await analyzeTextWithGemini(extractedTexts.join(''), "Tesseract.js + AI");
                }

            } catch (error) {
                 console.error("A critical error occurred during the Tesseract process, falling back to full Gemini AI:", error);
                 loaderText.textContent = "A critical error occurred. Falling back to Gemini AI...";
                 await callGeminiAPI();
            }
        }

        async function callGeminiAPI() {
            loaderText.textContent = "Analyzing images with Gemini AI...";
            const apiKey = "AIzaSyAeqR2CjRgeRKSrauhOG2JvYU4ZqEnnBpA";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const systemPrompt = `You are an expert AI assistant specializing in comparing grocery prices from multiple images. Your primary goal is to provide a complete and accurate comparison. For each image, identify the item, extract its price, and apply any visible discounts. Generate a top-level 'items' array with details for each product. Each item object must include: a rank, the total price, a 'price_per_kg' string, and a 'price_per_lb' string (e.g., '$5.50 / kg', '$2.49 / lb', or 'N/A' if not applicable). Also provide an overall 'comparison_summary' and a 'math_steps' string detailing your calculations (e.g., '$5.99 / 1.25 lbs = $4.79 per lb'). Respond ONLY with the specified JSON object.`;
            const userPrompt = `Analyze these ${uploadedImages.length} images. Provide a summary of your findings in the requested JSON format.`;

            const imageParts = uploadedImages.filter(Boolean).map(img => ({
                inline_data: { mime_type: "image/jpeg", data: img.base64 }
            }));

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ role: "user", parts: [{ text: userPrompt }, ...imageParts] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: getResponseSchema() }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error('Gemini API Error:', errorBody);
                    throw new Error('Gemini API request failed. Check your API key.');
                }
                const data = await response.json();
                const jsonResponse = JSON.parse(data.candidates[0].content.parts[0].text);
                displayResults(jsonResponse, "Gemini AI");
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                displayError(error.message);
            }
        }

        async function analyzeTextWithGemini(text, methodUsed) {
            const apiKey = "AIzaSyAeqR2CjRgeRKSrauhOG2JvYU4ZqEnnBpA";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const systemPrompt = `You are an expert AI assistant. You have been provided with raw text extracted from multiple grocery price tags. Your task is to analyze this text, identify each distinct item, its price, and any discounts. Then, compare them. Your primary goal is to provide a complete and accurate comparison. Generate a top-level 'items' array with details for each product. Each item object must include: a rank, the total price, a 'price_per_kg' string, and a 'price_per_lb' string (e.g., '$5.50 / kg', '$2.49 / lb', or 'N/A' if not applicable). Also provide an overall 'comparison_summary' and a 'math_steps' string detailing your calculations (e.g., '$5.99 / 1.25 lbs = $4.79 per lb'). Respond ONLY with the specified JSON object.`;
            const userPrompt = `Here is the text extracted from ${uploadedImages.length} images:\n\n${text}\n\nPlease analyze it and provide a summary of your findings in the requested JSON format.`;

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ role: "user", parts: [{ text: userPrompt }] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: getResponseSchema() }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                     const errorBody = await response.json();
                     console.error('Gemini Text Analysis Error:', errorBody);
                     throw new Error('AI text analysis failed.');
                }
                const data = await response.json();
                const jsonResponse = JSON.parse(data.candidates[0].content.parts[0].text);
                displayResults(jsonResponse, methodUsed);
            } catch (error) {
                console.error("Error analyzing text with Gemini, falling back to full Gemini AI:", error);
                loaderText.textContent = "Text analysis failed. Falling back to full Gemini AI...";
                await callGeminiAPI();
            }
        }
        
        function getResponseSchema() {
            return {
                type: "OBJECT",
                properties: {
                    comparison_summary: { type: "STRING" },
                    math_steps: { type: "STRING" },
                    items: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                name: { type: "STRING" },
                                description: { type: "STRING" },
                                price: { type: "STRING" },
                                rank: { type: "NUMBER" },
                                price_per_kg: { type: "STRING" },
                                price_per_lb: { type: "STRING" }
                            },
                            required: ["name", "description", "price", "rank", "price_per_kg", "price_per_lb"]
                        }
                    }
                },
                required: ["comparison_summary", "math_steps", "items"]
            };
        }

        function displayResults(data, methodUsed) {
            // Un-escape dollar signs from the main text fields
            document.getElementById('summary').textContent = data.comparison_summary.replace(/\\\$/g, '$');
            document.getElementById('mathSteps').textContent = data.math_steps.replace(/\\\$/g, '$');
            
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = ''; 
            const priceList = document.getElementById('priceList');
            priceList.innerHTML = ''; 

            // Sort items by rank before displaying
            const sortedItems = data.items.sort((a, b) => a.rank - b.rank);

            sortedItems.forEach((item) => {
                 // Un-escape dollar signs for each item before rendering
                item.price = item.price.replace(/\\\$/g, '$');
                item.price_per_kg = item.price_per_kg.replace(/\\\$/g, '$');
                item.price_per_lb = item.price_per_lb.replace(/\\\$/g, '$');
                item.description = item.description.replace(/\\\$/g, '$');
                
                const card = document.createElement('div');
                const isBestDeal = (item.rank === 1);
                
                if (isBestDeal) {
                    card.id = 'best-deal-card';
                }

                card.className = `p-6 rounded-2xl border border-slate-800 bg-slate-900/50 transition-all duration-300 transform flex flex-col`;
                if(isBestDeal) {
                    card.classList.add('best-deal-glow');
                }

                let rankHTML = '';
                if (data.items.length > 2) {
                    let ordinal;
                    if (item.rank === 1) ordinal = 'st';
                    else if (item.rank === 2) ordinal = 'nd';
                    else if (item.rank === 3) ordinal = 'rd';
                    else ordinal = 'th';
                    rankHTML = `<div class="mb-2"><span class="text-4xl font-bold text-cyan-400">${item.rank}</span><span class="text-2xl font-bold text-cyan-500">${ordinal}</span></div>`;
                }
                
                let unitPriceDisplayHTML = '';
                const kgPrice = item.price_per_kg && item.price_per_kg.toLowerCase() !== 'n/a' ? item.price_per_kg : null;
                const lbPrice = item.price_per_lb && item.price_per_lb.toLowerCase() !== 'n/a' ? item.price_per_lb : null;
                
                // Prefer kg as the unit to display on the card
                if (kgPrice) {
                    unitPriceDisplayHTML = `<p class="text-sm text-slate-500 mt-2">(${kgPrice})</p>`;
                } else if (lbPrice) {
                    unitPriceDisplayHTML = `<p class="text-sm text-slate-500 mt-2">(${lbPrice})</p>`;
                }


                card.innerHTML = `
                    <div class="flex-grow">
                        ${rankHTML}
                        <h3 class="text-lg font-semibold text-slate-300">${item.name}</h3>
                        <p class="text-slate-400 text-sm">${item.description}</p>
                    </div>
                    <div>
                        <p class="text-xl sm:text-2xl font-bold text-white mt-1">${item.price}</p>
                        ${unitPriceDisplayHTML}
                    </div>
                `;
                resultsGrid.appendChild(card);

                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 rounded-lg ${isBestDeal ? 'bg-yellow-400/10' : ''}`;
                
                let namePart = data.items.length > 2 ? `<span class="w-6 text-slate-500">${item.rank}.</span><span class="ml-2">${item.name}</span>` : `<span>${item.name}</span>`;
                
                let unitPriceHTML = '';
                // Use the already cleaned kgPrice and lbPrice variables from above
                if (kgPrice && lbPrice) {
                    unitPriceHTML = `<p class="text-sm text-slate-500 mt-1">${kgPrice} &bull; ${lbPrice}</p>`;
                } else if (kgPrice) {
                    unitPriceHTML = `<p class="text-sm text-slate-500 mt-1">${kgPrice}</p>`;
                } else if (lbPrice) {
                    unitPriceHTML = `<p class="text-sm text-slate-500 mt-1">${lbPrice}</p>`;
                }


                li.innerHTML = `
                    <div>
                        <div class="flex items-center font-medium ${isBestDeal ? 'text-yellow-300' : 'text-slate-300'}">
                            ${namePart}
                        </div>
                        ${unitPriceHTML}
                    </div>
                    <span class="text-lg ${isBestDeal ? 'text-yellow-300 font-bold' : 'text-slate-300'}">${item.price}</span>
                `;
                priceList.appendChild(li);
            });

            loader.classList.add('hidden');
            resultsContent.classList.remove('hidden');
            errorContent.classList.add('hidden');
            
            const priceListContainer = document.getElementById('priceListContainer');
            priceListContainer.classList.remove('hidden');
            
            resetBtn.parentElement.classList.remove('hidden');
            resetBtn.classList.remove('hidden');

            setTimeout(() => {
                const bestDealCard = document.getElementById('best-deal-card');
                if(bestDealCard) {
                    bestDealCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        function displayError(message = "The AI could not process the images. Please try again.") {
            loader.classList.add('hidden');
            resultsContent.classList.add('hidden');
            const p = errorContent.querySelector('p');
            p.textContent = message;
            errorContent.classList.remove('hidden');
            const priceListContainer = document.getElementById('priceListContainer');
            priceListContainer.classList.add('hidden');
            resetBtn.parentElement.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
        }

        function resetView() {
            uploadedImages = [];
            
            resultsContainer.classList.add('hidden');
            loader.classList.add('hidden');
            resultsContent.classList.add('hidden');
            errorContent.classList.add('hidden');
            
            const priceListContainer = document.getElementById('priceListContainer');
            const priceList = document.getElementById('priceList');
            priceList.innerHTML = '';
            priceListContainer.classList.add('hidden');
            
            resetBtn.parentElement.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderUI();
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderUI();
        }

        function initializeApp() {
            renderUI();
            imageSlotsContainer.addEventListener('click', (e) => {
                const removeButton = e.target.closest('[data-remove-index]');
                if (removeButton) {
                    e.preventDefault();
                    e.stopPropagation();
                    const indexToRemove = parseInt(removeButton.dataset.removeIndex, 10);
                    removeImage(indexToRemove);
                }
            });
        }

        resetBtn.addEventListener('click', resetView);
        
        // Initial setup
        initializeApp();
    </script>
</body>
</html>