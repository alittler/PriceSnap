<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Price Comparator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
        }
        /* Hide the default file input */
        input[type="file"] {
            display: none;
        }
        .best-deal-glow {
            box-shadow: 0 0 20px 7px rgba(250, 204, 21, 0.4); /* yellow-400 with opacity */
        }
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover; /* This will crop and center the image */
            border-radius: 0.75rem; /* rounded-lg */
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col items-center justify-start p-4 sm:p-6 md:p-8">

    <div class="w-full max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold bg-gradient-to-r from-amber-300 to-orange-400 text-transparent bg-clip-text">AI Price Comparator</h1>
            <p class="text-slate-400 mt-2 text-sm sm:text-base">Add up to 5 photos. Let AI find the best deal.</p>
        </header>

        <!-- Main Comparison Area -->
        <main id="imageSlotsContainer" class="flex flex-wrap justify-center gap-6">
            <!-- Image slots will be dynamically inserted here -->
        </main>

        <!-- Action Buttons -->
        <div id="actionButtons" class="text-center mt-8">
            <button id="resetBtn" class="hidden w-full sm:w-auto bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 px-10 rounded-full transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-slate-600/50">
                Start Over
            </button>
        </div>

        <!-- AI Results Section -->
        <div id="resultsContainer" class="w-full mx-auto mt-10 p-4 sm:p-6 rounded-xl hidden">
            <!-- Loading Spinner -->
            <div id="loader" class="text-center hidden">
                <svg class="animate-spin h-10 w-10 text-cyan-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-slate-400">AI is analyzing the images...</p>
            </div>
            <!-- Results Content -->
            <div id="resultsContent" class="hidden">
                <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-amber-300 to-orange-400 text-transparent bg-clip-text mb-6 text-center">Comparison Result</h2>
                <div id="summary" class="text-base sm:text-lg text-center bg-slate-800/50 border border-slate-700 p-4 rounded-xl mb-6 text-slate-300"></div>
                <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-center">
                    <!-- Result cards will be dynamically inserted here -->
                </div>
                <div class="mt-8 max-w-4xl mx-auto">
                    <h3 class="text-lg font-semibold text-slate-300 text-center">AI's Reasoning</h3>
                    <p id="reasoning" class="text-slate-400 bg-slate-800/50 border border-slate-700 p-4 rounded-xl mt-2"></p>
                </div>
            </div>
            <!-- Error Message -->
            <div id="errorContent" class="hidden text-center">
                <h2 class="text-xl font-bold text-red-500 mb-2">Analysis Failed</h2>
                <p class="text-slate-400">The AI could not process the images. Please try again with clearer photos.</p>
            </div>
        </div>

        <!-- Price List Section -->
        <div id="priceListContainer" class="w-full max-w-4xl mx-auto mt-8 hidden">
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-slate-300 text-center mb-4">Price Summary</h3>
                <ul id="priceList" class="text-slate-400 space-y-3">
                    <!-- Prices will be dynamically inserted here -->
                </ul>
            </div>
        </div>

    </div>

    <script type="module">
        // --- App State and Constants ---
        const MAX_IMAGES = 5;
        let uploadedImages = [];
        let unitComparisonsData = [];
        let currentUnitIndex = 0;

        // --- DOM Elements ---
        const imageSlotsContainer = document.getElementById('imageSlotsContainer');
        const resetBtn = document.getElementById('resetBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const loader = document.getElementById('loader');
        const resultsContent = document.getElementById('resultsContent');
        const errorContent = document.getElementById('errorContent');
        const priceListContainer = document.getElementById('priceListContainer');

        // --- UI Rendering ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const index = parseInt(event.target.dataset.index, 10);
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                uploadedImages[index] = {
                    src: base64String,
                    base64: base64String.split(',')[1]
                };
                renderUI();
                setTimeout(() => {
                    const lastSlot = imageSlotsContainer.children[imageSlotsContainer.children.length - 1];
                    if (lastSlot) {
                        lastSlot.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            };
            reader.readAsDataURL(file);
        }

        function createFilledSlot(src, index) {
            const slot = document.createElement('div');
            slot.className = "w-full max-w-sm h-64 md:h-80 bg-slate-900 rounded-2xl flex items-center justify-center border-2 border-solid border-slate-700 relative";
            slot.innerHTML = `<img src="${src}" class="absolute top-0 left-0 image-preview" alt="Grocery item ${index + 1}">`;
            return slot;
        }

        function createNewImageSlot(index) {
            const fileId = `file-${index}`;
            const label = document.createElement('label');
            label.htmlFor = fileId;
            label.className = "cursor-pointer group w-full max-w-sm h-64 md:h-80 bg-slate-900/50 rounded-2xl flex items-center justify-center border-2 border-dashed border-slate-800 transition-all duration-300 hover:border-cyan-500 hover:bg-slate-900";
            label.innerHTML = `<div class="text-center p-6 w-full h-full flex flex-col items-center justify-center relative"><div class="transition-transform duration-300 group-hover:scale-105"><svg class="w-16 h-16 mx-auto text-slate-600 group-hover:text-cyan-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p class="mt-2 font-semibold text-slate-400 group-hover:text-cyan-400">Add Photo ${index + 1}</p><p class="text-xs text-slate-500">Tap to use camera</p></div></div><input type="file" id="${fileId}" accept="image/*" capture="environment" data-index="${index}" class="hidden">`;
            label.querySelector('input').addEventListener('change', handleFileSelect);
            return label;
        }

        function createSpecialCompareSlot(index) {
            const fileId = `file-${index}`;
            const container = document.createElement('div');
            container.className = "w-full max-w-sm h-64 md:h-80 bg-slate-900/50 rounded-2xl flex flex-col border-2 border-dashed border-slate-800 overflow-hidden";
            container.innerHTML = `<label for="${fileId}" class="group cursor-pointer h-1/2 flex items-center justify-center transition-all duration-300 hover:bg-slate-900 relative p-4"><div class="transition-transform duration-300 group-hover:scale-105 text-center"><svg class="w-12 h-12 mx-auto text-slate-600 group-hover:text-cyan-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p class="mt-2 font-semibold text-slate-400 group-hover:text-cyan-400">Add Photo ${index + 1}</p></div><input type="file" id="${fileId}" accept="image/*" capture="environment" data-index="${index}" class="hidden"></label><div class="border-t-2 border-dashed border-slate-800"></div><button class="w-full h-1/2 bg-slate-900/50 hover:bg-slate-800 transition-colors text-cyan-400 font-semibold flex items-center justify-center p-4 text-lg">Calculate Best Deal</button>`;
            container.querySelector(`#${fileId}`).addEventListener('change', handleFileSelect);
            container.querySelector('button').addEventListener('click', callGemini);
            return container;
        }

        function renderUI() {
            imageSlotsContainer.innerHTML = '';
            uploadedImages.forEach((imgData, index) => {
                imageSlotsContainer.appendChild(createFilledSlot(imgData.src, index));
            });
            const imageCount = uploadedImages.length;
            if (imageCount < MAX_IMAGES) {
                const nextSlot = (imageCount < 2) ? createNewImageSlot(imageCount) : createSpecialCompareSlot(imageCount);
                imageSlotsContainer.appendChild(nextSlot);
            }
        }

        // --- API Call and Results ---
        async function callGemini() {
            resultsContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultsContent.classList.add('hidden');
            errorContent.classList.add('hidden');
            priceListContainer.classList.add('hidden');
            document.getElementById('priceList').innerHTML = '';
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

            const apiKey = "AIzaSyAeqR2CjRgeRKSrauhOG2JvYU4ZqEnnBpA"; // IMPORTANT: Add your Google AI API key here for the app to work.

            if (!apiKey) {
                displayError("API Key is missing. Please add your Google AI API key to the script to enable analysis.");
                return;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const systemPrompt = `You are an expert at analyzing photos of grocery store price tags. Your goal is to determine the best value by comparing unit prices.
- Identify the item name.
- Find the total price and the total weight/volume.
- Look for any sales, discounts, or special offers (e.g., "50% off", "Sale", "Club Price") and apply them to the final price.
- Calculate the price per common units (e.g., per ounce, per pound, per kg, per liter).
- If comparing different items (e.g., beef vs chicken), identify them as such. If they are the same item, label them as Image 1, Image 2, etc.
- Always define the "best deal" as the one with the LOWEST price per unit.
- Rank all items from best deal (rank 1) to worst.
- Provide a brief summary and reasoning for your conclusion.
- Respond ONLY with the specified JSON object.`;

            const userPrompt = "Analyze the provided images of grocery items and determine which offers the best value. Provide the result in the structured JSON format.";

            const imageParts = uploadedImages.filter(Boolean).map(img => ({
                inline_data: {
                    mime_type: "image/jpeg",
                    data: img.base64
                }
            }));

            const payload = {
                contents: [{
                    parts: [{ text: userPrompt }, ...imageParts]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            items: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        price: { type: "STRING" },
                                        description: { type: "STRING" },
                                        rank: { type: "INTEGER" }
                                    }
                                }
                            },
                            comparison_summary: { type: "STRING" },
                            reasoning: { type: "STRING" },
                            unit_comparisons: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        title: { type: "STRING" },
                                        items: {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: {
                                                    name: { type: "STRING" },
                                                    unit_price: { type: "STRING" }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API call failed: ${response.status} - ${errorBody}`);
                }
                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                    throw new Error("Invalid response structure from API.");
                }
                
                const jsonText = result.candidates[0].content.parts[0].text;
                const jsonData = JSON.parse(jsonText);
                displayResults(jsonData);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                displayError();
            }
        }

        function displayResults(data) {
            resultsContainer.classList.remove('hidden');
            document.getElementById('summary').textContent = data.comparison_summary;
            document.getElementById('reasoning').textContent = data.reasoning;
            unitComparisonsData = data.unit_comparisons || [];
            currentUnitIndex = 0;

            const resultsGrid = document.getElementById('resultsGrid');
            const priceList = document.getElementById('priceList');
            resultsGrid.innerHTML = '';
            priceList.innerHTML = '';

            data.items.forEach((item, index) => {
                const isBestDeal = (item.rank === 1);
                const card = document.createElement('div');
                card.className = `p-6 rounded-2xl border border-slate-800 bg-slate-900/50 transition-all duration-300 transform`;
                let rankHTML = '';
                if (data.items.length > 2) {
                    let ordinal = 'th';
                    if (item.rank === 1) ordinal = 'st'; else if (item.rank === 2) ordinal = 'nd'; else if (item.rank === 3) ordinal = 'rd';
                    rankHTML = `<div class="mb-2"><span class="text-4xl font-bold text-cyan-400">${item.rank}</span><span class="text-2xl font-bold text-cyan-500">${ordinal}</span></div>`;
                }
                card.innerHTML = `${rankHTML}<h3 class="text-lg font-semibold text-slate-300">${item.name}</h3><p class="text-slate-400 text-sm">${item.description}</p><p class="text-xl sm:text-2xl font-bold text-white mt-1">${item.price}</p>${isBestDeal ? `<div class="mt-3 inline-block bg-yellow-400/20 text-yellow-300 text-xs font-semibold px-3 py-1 rounded-full">🏆 Best Deal</div>` : ''}`;
                resultsGrid.appendChild(card);

                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 rounded-lg ${isBestDeal ? 'bg-yellow-400/10' : ''}`;
                let namePart = data.items.length > 2 ? `<span class="w-6 text-slate-500">${item.rank}.</span><span class="ml-2">${item.name}</span>` : `<span>${item.name}</span>`;
                li.innerHTML = `<div class="flex items-center font-medium ${isBestDeal ? 'text-yellow-300' : 'text-slate-300'}">${namePart}</div><span class="${isBestDeal ? 'text-yellow-300 font-bold' : 'text-slate-400'}">${item.price}</span>`;
                priceList.appendChild(li);
            });

            if (unitComparisonsData.length > 0) {
                const comparisonCard = document.createElement('div');
                comparisonCard.id = 'unitComparisonCard';
                comparisonCard.className = `md:col-span-2 lg:col-span-3 p-6 rounded-2xl border border-cyan-500 bg-slate-900 text-left cursor-pointer group`;
                comparisonCard.addEventListener('click', cycleUnits);
                resultsGrid.appendChild(comparisonCard);
                updateUnitComparisonView();
            }

            loader.classList.add('hidden');
            resultsContent.classList.remove('hidden');
            errorContent.classList.add('hidden');
            priceListContainer.classList.remove('hidden');
            resetBtn.parentElement.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            
            setTimeout(() => {
                const comparisonTable = document.getElementById('unitComparisonCard');
                if(comparisonTable) comparisonTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            
        }

        function displayError(message = "The AI could not process the images. Please try again with clearer photos.") {
            loader.classList.add('hidden');
            resultsContent.classList.add('hidden');
            const errorContentDiv = document.getElementById('errorContent');
            errorContentDiv.querySelector('p').textContent = message;
            errorContent.classList.remove('hidden');
            priceListContainer.classList.add('hidden');
            resetBtn.parentElement.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
        }

        function resetView() {
            uploadedImages = [];
            unitComparisonsData = [];
            currentUnitIndex = 0;
            resultsContainer.classList.add('hidden');
            loader.classList.add('hidden');
            resultsContent.classList.add('hidden');
            errorContent.classList.add('hidden');
            resetBtn.parentElement.classList.add('hidden');
            resetBtn.classList.add('hidden');
            priceListContainer.classList.add('hidden'); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderUI();
        }

        function updateUnitComparisonView() {
            const comparisonCard = document.getElementById('unitComparisonCard');
            if (!comparisonCard || unitComparisonsData.length === 0) return;
            const currentComparison = unitComparisonsData[currentUnitIndex];
            let comparisonItemsHTML = currentComparison.items.map((item, index) => `<div class="flex justify-between items-center py-3 border-b border-slate-800 last:border-b-0"><span class="font-medium ${index === 0 ? 'text-yellow-300' : 'text-slate-300'}">${index + 1}. ${item.name}</span><span class="font-bold ${index === 0 ? 'text-yellow-300' : 'text-white'}">${item.unit_price}</span></div>`).join('');
            comparisonCard.innerHTML = `<h3 class="flex items-center justify-between text-xl font-semibold text-cyan-400 mb-4"><span>${currentComparison.title}</span><svg class="w-5 h-5 text-slate-500 group-hover:text-cyan-300 transition-colors" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691L7.985 5.944m0 0L4.804 9.126m3.182-3.182a8.25 8.25 0 0111.667 0l3.181 3.183" /></svg></h3><div class="space-y-1">${comparisonItemsHTML}</div>`;
        }
        
        function cycleUnits() {
            if (unitComparisonsData.length > 1) {
                currentUnitIndex = (currentUnitIndex + 1) % unitComparisonsData.length;
                updateUnitComparisonView();
            }
        }
        
        // --- App Initialization ---
        function startApp() {
            renderUI();
        }

        resetBtn.addEventListener('click', resetView);
        startApp();
    </script>
</body>
</html>


