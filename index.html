<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceSnap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
 <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-bold-rounded/css/uicons-bold-rounded.css'>   
    <!-- Tesseract.js CDN -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
        }
        /* Hide the default file input */
        input[type="file"] {
            display: none;
        }
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover; /* This will crop and center the image */
            border-radius: 0.75rem; /* rounded-lg */
        }
        .best-deal-glow {
            box-shadow: 0 0 15px 4px rgba(250, 204, 21, 0.4); /* amber-300 glow */
            border-color: #FBBF24 !important; /* amber-400 */
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col items-center justify-start p-4 sm:p-6 md:p-8">

    <div class="w-full max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 flex flex-col items-center justify-center">
            <div class="flex items-center gap-4">
                 <svg class="w-12 h-12 sm:w-14 sm:h-14 text-amber-300" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21.24 13.62L16.2 20.26c-1.42 1.86-3.88 2.45-6.02 1.43l-5.18-2.48c-2.14-1.02-3.1-3.56-2.08-5.7l5.04-10.48c1.02-2.14 3.56-3.1 5.7-2.08l5.18 2.48c2.14 1.02 3.1 3.56 2.08 5.7z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.5"/>
                    <circle cx="17.5" cy="6.5" r="1" fill="currentColor"/>
                </svg>
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold bg-gradient-to-r from-amber-300 to-orange-400 text-transparent bg-clip-text">PriceSnap</h1>
            </div>
            <p class="text-slate-400 mt-2 text-sm sm:text-base">Add up to 5 photos. Let AI find the best deal.</p>
        </header>

        <!-- Main Comparison Area -->
        <main id="imageSlotsContainer" class="flex flex-wrap justify-center gap-6">
            <!-- Image slots will be dynamically inserted here -->
        </main>

        <!-- Action Buttons -->
        <div id="actionButtons" class="mt-8 flex justify-center">
             <button id="resetBtn" class="hidden w-full max-w-sm bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 px-10 rounded-full transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-slate-600/50">
                Start New Comparison
            </button>
        </div>

        <!-- AI Results Section -->
        <div id="resultsContainer" class="w-full mx-auto mt-10 p-4 sm:p-6 rounded-xl hidden">
            <!-- Loading Spinner -->
            <div id="loader" class="text-center hidden">
                <svg class="animate-spin h-10 w-10 text-cyan-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loaderText" class="mt-4 text-slate-400">AI is analyzing the images...</p>
            </div>
            <!-- Results Content -->
            <div id="resultsContent" class="hidden">
                <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-center mb-8">
                    <!-- Result cards will be dynamically inserted here -->
                </div>

                <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-amber-300 to-orange-400 text-transparent bg-clip-text mb-6 text-center">Comparison Result</h2>
                <div id="summary" class="text-base sm:text-lg text-center bg-slate-800/50 border border-slate-700 p-4 rounded-xl mb-6 text-slate-300"></div>
                
                <!-- Price List Section -->
                <div id="priceListContainer" class="w-full max-w-4xl mx-auto mb-8">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-slate-300 text-center mb-4">Price Summary</h3>
                        <ul id="priceList" class="text-slate-400 space-y-3">
                            <!-- Prices will be dynamically inserted here -->
                        </ul>
                    </div>
                </div>

                <div class="mt-8 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-slate-300 text-center">Math Steps</h3>
                    </div>
                    <p id="mathSteps" class="text-slate-400 bg-slate-800/50 border border-slate-700 p-4 rounded-xl mt-2 whitespace-pre-line"></p>
                </div>
            </div>
            <!-- Error Message -->
            <div id="errorContent" class="hidden text-center">
                <h2 class="text-xl font-bold text-red-500 mb-2">Analysis Failed</h2>
                <p class="text-slate-400">The AI could not process the images. Please try again with clearer photos.</p>
            </div>
        </div>

        <footer class="text-center mt-12 mb-4">
            <p class="text-xs text-slate-600">PriceSnap build-local</p>
        </footer>
    </div>

    <script>
        const MAX_IMAGES = 5;
        let uploadedImages = [];

        const imageSlotsContainer = document.getElementById('imageSlotsContainer');
        const resetBtn = document.getElementById('resetBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const resultsContent = document.getElementById('resultsContent');
        const errorContent = document.getElementById('errorContent');
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const index = parseInt(event.target.dataset.index, 10);
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                uploadedImages[index] = {
                    src: base64String,
                    base64: base64String.split(',')[1]
                };
                renderUI(); 
                
                if (index === uploadedImages.length - 1 && uploadedImages.length < MAX_IMAGES) {
                    setTimeout(() => {
                        const allSlots = imageSlotsContainer.children;
                        const lastSlot = allSlots[allSlots.length - 1];
                        if (lastSlot) {
                            lastSlot.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            };
            reader.readAsDataURL(file);
        }

        function createFilledSlot(src, index) {
            const fileId = `file-replace-${index}`;
            const slot = document.createElement('div');
            slot.className = "group w-full max-w-sm h-64 md:h-80 bg-slate-900 rounded-2xl flex items-center justify-center border-2 border-solid border-slate-700 relative overflow-hidden";
            
            slot.innerHTML = `
                <label for="${fileId}" class="absolute inset-0 cursor-pointer">
                    <img src="${src}" class="absolute top-0 left-0 image-preview transition-transform duration-300 group-hover:scale-105" alt="Grocery item ${index + 1}">
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center p-4">
                        <i class="fi fi-br-image-slash text-4xl text-white"></i>
                        <p class="mt-2 text-white font-semibold text-center">Change Photo</p>
                    </div>
                    <input type="file" id="${fileId}" accept="image/*" data-index="${index}" class="hidden">
                </label>
                <button data-remove-index="${index}" class="absolute top-3 right-3 z-10 p-2 bg-slate-900/50 hover:bg-red-600/80 rounded-full transition-colors">
                    <svg class="w-5 h-5 text-white pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;

            const input = slot.querySelector('input');
            input.addEventListener('change', handleFileSelect);
            return slot;
        }

        function createNewImageSlot(index) {
            const fileId = `file-${index}`;
            const label = document.createElement('label');
            label.htmlFor = fileId;
            label.className = "cursor-pointer group w-full max-w-sm h-64 md:h-80 bg-slate-900/50 rounded-2xl flex items-center justify-center border-2 border-dashed border-slate-800 transition-all duration-300 hover:border-cyan-500 hover:bg-slate-900";
            label.innerHTML = `
                <div class="text-center p-6 w-full h-full flex flex-col items-center justify-center relative">
                    <div class="transition-transform duration-300 group-hover:scale-105">
                        <svg class="w-16 h-16 mx-auto text-slate-600 group-hover:text-cyan-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="mt-2 font-semibold text-slate-400 group-hover:text-cyan-400">Add Photo ${index + 1}</p>
                        <p class="text-xs text-slate-500">Tap to use camera or gallery</p>
                    </div>
                </div>
                <input type="file" id="${fileId}" accept="image/*" data-index="${index}" class="hidden">
            `;
            const input = label.querySelector('input');
            input.addEventListener('change', handleFileSelect);
            return label;
        }

        function createSpecialCompareSlot(index) {
            const fileId = `file-${index}`;
            const container = document.createElement('div');
            container.className = "w-full max-w-sm h-64 md:h-80 bg-slate-900/50 rounded-2xl flex flex-col border-2 border-dashed border-slate-800 overflow-hidden";
            
            container.innerHTML = `
                <label for="${fileId}" class="group cursor-pointer h-1/2 flex items-center justify-center transition-all duration-300 hover:bg-slate-900 relative p-4">
                    <div class="transition-transform duration-300 group-hover:scale-105 text-center">
                        <svg class="w-12 h-12 mx-auto text-slate-600 group-hover:text-cyan-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="mt-2 font-semibold text-slate-400 group-hover:text-cyan-400">Add Photo ${index + 1}</p>
                    </div>
                    <input type="file" id="${fileId}" accept="image/*" data-index="${index}" class="hidden">
                </label>
                <div class="border-t-2 border-dashed border-slate-800"></div>
                <button class="w-full h-1/2 bg-slate-900/50 hover:bg-slate-800 transition-colors text-cyan-400 font-semibold flex items-center justify-center p-4 text-lg">
                    Calculate Best Deal
                </button>
            `;
            
            const input = container.querySelector(`#${fileId}`);
            input.addEventListener('change', handleFileSelect);

            const compareBtn = container.querySelector('button');
            compareBtn.addEventListener('click', startAnalysis);
            
            return container;
        }

        function renderUI() {
            imageSlotsContainer.innerHTML = ''; 
            const validImages = uploadedImages.filter(Boolean);
            validImages.forEach((imgData, index) => {
                imageSlotsContainer.appendChild(createFilledSlot(imgData.src, index));
            });
            if (validImages.length < MAX_IMAGES) {
                const nextSlot = (validImages.length < 2) ? createNewImageSlot(validImages.length) : createSpecialCompareSlot(validImages.length);
                imageSlotsContainer.appendChild(nextSlot);
            }
        }

        function prepareForAnalysis() {
            resultsContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultsContent.classList.add('hidden');
            errorContent.classList.add('hidden');
            const priceListContainer = document.getElementById('priceListContainer');
            priceListContainer.classList.add('hidden');
            document.getElementById('priceList').innerHTML = '';
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        async function startAnalysis() {
            prepareForAnalysis();
            await callGeminiAPI();
        }
        
        async function callGeminiAPI() {
            loaderText.textContent = `Analyzing with Gemini AI...`;
            const apiKey = "AIzaSyDySp9D6chCo8LrWfzvxhxnCGFex8-DIPw";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const systemPrompt = `You are an expert AI assistant specializing in comparing grocery prices. Your primary goal is to provide a complete and mathematically accurate comparison. For each item (from image or text), identify the product, extract its price, and apply any visible discounts. The 'rank' must be determined by sorting the items from lowest to highest based on their calculated price per kilogram ('price_per_kg'). Generate a top-level 'items' array with details for each product. Each item object must include: 'name', 'description', 'price' (total as a string like '$12.34'), 'rank' (number), 'price_per_kg' (number), 'price_per_lb' (number), 'conversion_details' (string, e.g., '$6.23 for 0.189 kg'), and 'is_estimated' (a boolean). If you estimate the weight for a 'per each' item, set 'is_estimated' to true; otherwise, set it to false. For unit prices, provide only the number; if not applicable, use -1. Also provide an overall 'comparison_summary' and a 'math_steps' string detailing your calculations. Crucially, if an item is priced 'per each', use your knowledge to estimate a typical weight for one item (e.g., 'avocado avg. weight 0.17kg') and use that estimate for the unit price calculation. You MUST state the estimated weight you used in the 'math_steps' for transparency. All mathematical conversions and calculations MUST be accurate. For example, 1 lb = 0.453592 kg. If a price is $22.98 for 1.92 lb, the weight in kg is 1.92 * 0.453592 = 0.871 kg. The price per kg is $22.98 / 0.871 kg = $26.38. Your 'price_per_kg' value MUST reflect this accurate calculation. Respond ONLY with the specified JSON object.`;

            const imageParts = uploadedImages.filter(Boolean).map(img => ({
                inline_data: { mime_type: "image/jpeg", data: img.base64 }
            }));
            
            const userPrompt = `Analyze these ${uploadedImages.length} images. Provide a summary of your findings in the requested JSON format.`;
            const contentParts = [{ text: userPrompt }, ...imageParts];

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ role: "user", parts: contentParts }],
                generationConfig: { responseMimeType: "application/json", responseSchema: getResponseSchema() }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error('Gemini API Error:', errorBody);
                    if (response.status === 403) {
                        if (errorBody.error?.details?.[0]?.reason === 'SERVICE_DISABLED') {
                            const activationUrl = errorBody.error.details[0].metadata.activationUrl;
                            throw new Error(`The Generative Language API is not enabled for your project. Please enable it here: ${activationUrl}`);
                        }
                        if (errorBody.error?.details?.[0]?.reason === 'API_KEY_HTTP_REFERRER_BLOCKED') {
                             throw new Error('API Key is restricted. In your Google Cloud Console, please edit your API key and under "Application restrictions", set it to "None" to fix this.');
                        }
                    }
                    throw new Error('Gemini API request failed. Check your API key and permissions.');
                }
                const data = await response.json();
                const jsonResponse = JSON.parse(data.candidates[0].content.parts[0].text);
                displayResults(jsonResponse);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                displayError(error.message);
            }
        }
        
        function getResponseSchema() {
            return {
                type: "OBJECT",
                properties: {
                    comparison_summary: { type: "STRING" },
                    math_steps: { type: "STRING" },
                    items: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                name: { type: "STRING" },
                                description: { type: "STRING" },
                                price: { type: "STRING" },
                                rank: { type: "NUMBER" },
                                price_per_kg: { type: "NUMBER" },
                                price_per_lb: { type: "NUMBER" },
                                conversion_details: { type: "STRING" },
                                is_estimated: { type: "BOOLEAN" }
                            },
                            required: ["name", "description", "price", "rank", "price_per_kg", "price_per_lb", "conversion_details", "is_estimated"]
                        }
                    }
                },
                required: ["comparison_summary", "math_steps", "items"]
            };
        }

        function displayResults(data) {
            document.getElementById('summary').textContent = data.comparison_summary.replace(/\\\$/g, '$');
            document.getElementById('mathSteps').textContent = data.math_steps.replace(/\\\$/g, '$');
            
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = ''; 
            const priceList = document.getElementById('priceList');
            priceList.innerHTML = ''; 

            const sortedItems = data.items.sort((a, b) => {
                const priceA = a.price_per_kg;
                const priceB = b.price_per_kg;
                if (priceA <= 0 && priceB > 0) return 1;
                if (priceB <= 0 && priceA > 0) return -1;
                if (priceA <= 0 && priceB <= 0) return 0;
                return priceA - priceB;
            });

            sortedItems.forEach((item, index) => {
                item.rank = index + 1; // Re-assign rank based on correct sorting
                const cleanedItem = {
                    ...item,
                    price: item.price.replace(/\\\$/g, '$'),
                    description: item.description.replace(/\\\$/g, '$'),
                    conversion_details: item.conversion_details.replace(/\\\$/g, '$'),
                };
                
                const isBestDeal = (cleanedItem.rank === 1);
                resultsGrid.appendChild(createResultCard(cleanedItem, isBestDeal, sortedItems.length));
                priceList.appendChild(createPriceListItem(cleanedItem, isBestDeal, sortedItems.length > 2));
            });

            loader.classList.add('hidden');
            resultsContent.classList.remove('hidden');
            errorContent.classList.add('hidden');
            document.getElementById('priceListContainer').classList.remove('hidden');
            resetBtn.parentElement.classList.remove('hidden');
            resetBtn.classList.remove('hidden');

            setTimeout(() => {
                const bestDealCard = document.getElementById('best-deal-card');
                bestDealCard?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
        
        function createResultCard(item, isBestDeal, totalItems) {
            const card = document.createElement('div');
            if (isBestDeal) card.id = 'best-deal-card';

            card.className = `p-6 rounded-2xl border border-slate-800 bg-slate-900/50 transition-all duration-300 transform flex flex-col result-card ${isBestDeal ? 'best-deal-glow' : ''}`;
            
            let rankHTML = '';
            if (totalItems > 1 && item.rank > 1) {
                const ordinals = {2: 'nd', 3: 'rd'};
                const ordinal = ordinals[item.rank] || 'th';
                rankHTML = `<div class="mb-2"><span class="text-4xl font-bold text-cyan-400">${item.rank}</span><span class="text-2xl font-bold text-cyan-500">${ordinal}</span></div>`;
            } else if (isBestDeal && totalItems > 1) {
                 rankHTML = `<div class="mb-2"><span class="text-4xl font-bold text-amber-300">1</span><span class="text-2xl font-bold text-amber-400">st</span></div>`;
            }

            const estText = item.is_estimated ? ' (est.)' : '';
            const kgPrice = item.price_per_kg > 0 ? `$${item.price_per_kg.toFixed(2)} / kg` : 'N/A';

            card.innerHTML = `
                <div class="flex-grow">
                    ${rankHTML}
                    <h3 class="text-lg font-semibold text-slate-300">${item.name}</h3>
                    <p class="text-slate-400 text-sm">${item.description}</p>
                </div>
                <div>
                    <p class="text-xl sm:text-2xl font-bold text-white mt-1">${kgPrice}${estText}</p>
                    <p class="text-sm text-slate-500 mt-1">(${item.conversion_details})</p>
                </div>
            `;
            return card;
        }

        function createPriceListItem(item, isBestDeal, showRank) {
            const li = document.createElement('li');
            li.className = `flex justify-between items-center p-3 rounded-lg ${isBestDeal ? 'bg-yellow-400/10' : ''}`;
            
            const namePart = showRank ? `<span class="w-6 text-slate-500">${item.rank}.</span><span class="ml-2">${item.name}</span>` : `<span>${item.name}</span>`;
            const estText = item.is_estimated ? ' (est.)' : '';
            
            const kgPrice = item.price_per_kg > 0 ? `$${item.price_per_kg.toFixed(2)} / kg` + estText : null;
            const lbPrice = item.price_per_lb > 0 ? `$${item.price_per_lb.toFixed(2)} / lb` + estText : null;

            let unitPriceHTML = '';
            if (kgPrice && lbPrice) unitPriceHTML = `<p class="text-sm text-slate-500 mt-1">${kgPrice} &bull; ${lbPrice}</p>`;
            else if (kgPrice) unitPriceHTML = `<p class="text-sm text-slate-500 mt-1">${kgPrice}</p>`;
            else if (lbPrice) unitPriceHTML = `<p class="text-sm text-slate-500 mt-1">${lbPrice}</p>`;

            li.innerHTML = `
                <div>
                    <div class="flex items-center font-medium ${isBestDeal ? 'text-yellow-300' : 'text-slate-300'}">
                        ${namePart}
                    </div>
                    ${unitPriceHTML}
                </div>
                <span class="text-lg ${isBestDeal ? 'text-yellow-300 font-bold' : 'text-slate-300'}">${item.price}</span>
            `;
            return li;
        }

        function displayError(message = "The AI could not process the images. Please try again.") {
            loader.classList.add('hidden');
            resultsContent.classList.add('hidden');
            const p = errorContent.querySelector('p');
            p.textContent = message;
            errorContent.classList.remove('hidden');
            document.getElementById('priceListContainer').classList.add('hidden');
            resetBtn.parentElement.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
        }

        function resetView() {
            uploadedImages = [];
            
            resultsContainer.classList.add('hidden');
            loader.classList.add('hidden');
            resultsContent.classList.add('hidden');
            errorContent.classList.add('hidden');
            
            const priceListContainer = document.getElementById('priceListContainer');
            priceListContainer.querySelector('ul').innerHTML = '';
            priceListContainer.classList.add('hidden');
            
            resetBtn.parentElement.classList.add('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderUI();
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderUI();
        }

        function initializeApp() {
            renderUI();
            
            document.body.addEventListener('click', (e) => {
                const removeButton = e.target.closest('[data-remove-index]');
                if (removeButton) {
                    e.preventDefault();
                    e.stopPropagation();
                    removeImage(parseInt(removeButton.dataset.removeIndex, 10));
                    return;
                }
            });
            resetBtn.addEventListener('click', resetView);
        }

        // Initial setup
        initializeApp();
    </script>
</body>
</html>

